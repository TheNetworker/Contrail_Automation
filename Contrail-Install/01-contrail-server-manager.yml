# Copyright 2018, Juniper Networks Pvt Ltd.
# All rights reserved.
# command example: ansible-playbook -i all.inv 01-contrail-server-manager.yml
---
- name: install contrail
  hosts: contrail-ubuntu-vm
  tasks:

    - name: Import variables from the file /vars/contrail.info into 'info' variable
      include_vars:
        file: contrail.info
        name: info

    - name: download contrail-server-manager
      get_url:
        url: http://{{ info.contrail_package[0].file_server }}/contrail-server-manager-installer_{{ info.contrail_package[0].contrail_version }}_{{ info.host_vm[0].ubuntu_version }}.deb
        dest: ~/packages/contrail-server-manager-installer_{{ info.contrail_package[0].contrail_version }}_{{ info.host_vm[0].ubuntu_version }}.deb

    - name: download contrail-cloud-docker
      get_url:
        url: http://{{ info.contrail_package[0].file_server }}/contrail-cloud-docker_{{ info.contrail_package[0].contrail_version }}-{{ info.contrail_package[0].package_sku}}_{{ info.host_vm[0].ubuntu_version }}.tgz
        dest: ~/packages/contrail-cloud-docker_{{ info.contrail_package[0].contrail_version }}-{{ info.contrail_package[0].package_sku}}_{{ info.host_vm[0].ubuntu_version }}.tgz

    - name: create packages directory
      file: state=directory path=~/packages

    - name: create json directory
      file: state=directory path=~/json

    - name: parametrized template - a
      template:
        src: ~/Contrail_Automation/templates/contrail-install.j2
        dest: ~/json/contrail-install.json

    - name: Install a server manager deb package
      apt:
        deb: ~/packages/contrail-server-manager-installer_{{ info.contrail_package[0].contrail_version }}_{{ info.host_vm[0].ubuntu_version }}.deb

    - name: Install contrail
      shell: /opt/contrail/contrail_server_manager/provision_containers.sh -j /root/json/contrail-install.json -ip "{{ info.host_vm[0].ip_address.split('/')[0] }}" -sku "{{ info.contrail_package[0].package_sku}}"
      register: installation_result
      args:
        executable: /bin/bash
    - debug:
        var: installation_result.stdout_lines

    - name: Wait for the Server Manager Provisioning to complete
      shell: server-manager status server
      register: results
      args:
        executable: /bin/bash
      until: results.stdout.find("provision_completed") != -1
      retries: 50
      delay: 20
    - debug:
        var: results.stdout

